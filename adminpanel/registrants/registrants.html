<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="/css/bootstrap.css" />
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
      integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
      crossorigin="anonymous"
    ></script>

    <script src="/js/sidebar.js"></script>

    <link rel="stylesheet" href="/style.css" />
    <title>SysAdmin Control Panel</title>

    <script>
      var registrantsList;
      var selectedRegistrant;
      var selectedTopic = 0;

      function viewButton(id) {
        return `
        <button
          onclick="handleView(value)"
          value="${id}"
          class="btn btn-primary btn-sm"
        >
          View Details
        </button>
        `;
      }

      function updateRegistrants() {
        data = Array(4);
        data[0] = Object({ name: "action", value: "get" });
        data[1] = Object({ name: "approved", value: 0 });
        data[2] = Object({ name: "orderby", value: $("#orderby").val() });
        data[3] = Object({ name: "topic", value: $("#topic").val() });
        $.ajax({
          type: "POST",
          url: "/api/registrants",
          data: data,
          dataType: "json",
          success: function (data) {
            if (data.success) {
              $("#registrants-table").empty();
              registrantsList = data.registrants;
              data.registrants.map(function (registrant) {
                $("#registrants-table").append(
                  `<tr>
                  <th scope="row">${registrant["registrant_id"]}</th>
                  <td>${registrant["name"]}</td>
                  <td>${registrant["surname"]}</td>
                  <td>${registrant["topic"]}</td>
                  <td>${registrant["country"]}</td>
                  <td>${viewButton(registrant["registrant_id"])}</td>
                </tr>`
                );
              });
            } else {
              alert(data.msg);
            }
          },

          error: function (data) {
            alert(data.responseJSON.msg + "\n" + data.responseJSON.error);
          },
        });
      }

      function getTopics(update = false) {
        data = Array(1);
        data[0] = Object({ name: "action", value: "get" });
        $.ajax({
          type: "POST",
          url: "/api/topics",
          data: data,
          dataType: "json",
          success: function (data) {
            if (data.success) {
              data.topics.map(function (topic) {
                if (selectedTopic == -1) selectedTopic = topic[0];
                $("#topic").append(
                  `<option value=${topic[0]}>${topic[1]}</option>`
                );
              });
              if (update) updateRegistrants(selectedTopic);
            }
          },
          error: function (data) {
            console.log(data);
            alert(data.responseJSON.msg + "\n" + data.responseJSON.error);
          },
        });
      }

      $(document).ready(function (event) {
        getTopics((update = true));
        $("#registrant-info").hide();
        $("#approval").submit(function (event) {
          event.preventDefault();
          console.log(this.approval);
        });
      });

      function checkID(registrant) {
        return registrant["registrant_id"] == this;
      }

      function handleView(id) {
        if (id != 0) {
          registrant = registrantsList.find(checkID, id);
          selectedRegistrant = registrant;
          // If Server uses UTC timezone
          datetmp = new Date(registrant["time"].date);
          date = new Date(
            Date.UTC(
              datetmp.getFullYear(),
              datetmp.getMonth(),
              datetmp.getDate(),
              datetmp.getHours(),
              datetmp.getMinutes(),
              datetmp.getSeconds(),
              datetmp.getMilliseconds()
            )
          );

          // If Server uses local timezone
          // date = new Date(registrant["time"].date);
          date = date.toLocaleString("ru-RU", {
            timeZone: "Asia/Oral",
          });
          $("#name").html(registrant["name"]);
          $("#surname").html(registrant["surname"]);
          $("#time").html(date);
          fullinstitution =
            registrant["institution"] +
            ` | <a target="_blank" rel="noopener noreferrer" href="https://2gis.kz/kazakhstan/search/${registrant["institution"]}">View Map</a>` +
            (registrant["role"] == "teacher"
              ? "<br>Teacher" +
                (registrant["subject"] != null
                  ? ": " + registrant["subject"]
                  : "")
              : registrant["role"] == "student"
              ? "<br>Student" +
                (registrant["major"] != null ? ": " + registrant["major"] : "")
              : "<br>School Student" +
                (registrant["grade"] != null
                  ? ": " + registrant["grade"]
                  : "") +
                (registrant["gradeletter"] != null
                  ? " " + registrant["gradeletter"]
                  : ""));
          $("#institution").html(fullinstitution);
          $("#email").html(
            `<a href="mailto:${registrant["email"]}">${registrant["email"]}</a>`
          );
          $("#phone").html(registrant["phone"]);
          $("#country").html(registrant["country"]);
          $("#registrant-info").show();
        } else {
          $("#registrant-info").hide();
        }
      }

      function confirmApproval(action) {
        $("#confirm").modal("show");
        $("#confirm-text").html(
          `Do you want to ${
            action == "local"
              ? "approve "
              : action == "foreign"
              ? "approve "
              : "deny "
          } ${selectedRegistrant["name"]} ${selectedRegistrant["surname"]} ${
            action == "local"
              ? "as a participant from host institution?"
              : action == "foreign"
              ? "as a participant from foreign institution?"
              : "?"
          }`
        );
        $("#confirm-btn").val(action);
      }

      function handleApproval(action) {
        console.log(action);
        data = Array(2);
        data[0] = Object({ name: "action", value: action });
        data[1] = Object({
          name: "id",
          value: selectedRegistrant["registrant_id"],
        });
        $.ajax({
          type: "POST",
          url: "/api/approval",
          data: data,
          dataType: "json",
          success: function (data) {
            if (data.success) {
              console.log(data);
              updateRegistrants();
              handleView(0);
            } else {
              alert(data.msg);
              console.log(data.error);
            }
            $("#confirm").modal("hide");
          },

          error: function (data) {
            $("#confirm").modal("hide");
            alert(data.responseJSON.msg + "\n" + data.responseJSON.error);
            console.log(data.responseJSON);
          },
        });
      }
    </script>
  </head>

  <body style="display: none;">
    <div id="1" class="container-fluid">
      <div id="2" class="row">
        <div class="col-10">
          <div
            class="tab-content"
            id="tabContent"
            style="padding-top: 30px; padding-left: 30px;"
          >
            <h1>Registrants</h1>
            Order by
            <select onchange="updateRegistrants()" name="orderby" id="orderby">
              <option value="name">Name</option>
              <option value="surname" selected>Surname</option>
              <option value="country">Country</option>
              <option value="time">Time</option>
            </select>
            with topic
            <select onchange="updateRegistrants()" name="topic" id="topic"
              ><option value="0">All</option></select
            >
            <div class="table-scroll mb-3">
              <table class="table table-striped table-bordered">
                <thead>
                  <tr>
                    <th style="width: 20px;" scope="col">ID</th>
                    <th scope="col">Name</th>
                    <th scope="col">Surname</th>
                    <th scope="col">Topic</th>
                    <th scope="col">Country</th>
                    <th style="width: 95px;" scope="col">Action</th>
                  </tr>
                </thead>
                <tbody id="registrants-table"></tbody>
              </table>
            </div>
            <div id="registrant-info">
              <table class="table-borderless col-8 table-sm mb-4">
                <thead>
                  <th style="width: 175px;"></th>
                  <th></th>
                </thead>
                <tbody>
                  <tr>
                    <th>Name:</th>
                    <td id="name">N/A</td>
                  </tr>
                  <tr>
                    <th>Surname:</th>
                    <td id="surname">N/A</td>
                  </tr>
                  <tr>
                    <th>Registration Datetime:</th>
                    <td id="time">N/A</td>
                  </tr>
                  <tr>
                    <th></th>
                    <td></td>
                  </tr>
                  <tr>
                    <th>Institution:</th>
                    <td id="institution">N/A</td>
                  </tr>
                  <tr>
                    <th>Email:</th>
                    <td id="email">N/A</td>
                  </tr>
                  <tr>
                    <th>Phone:</th>
                    <td id="phone">N/A</td>
                  </tr>
                  <tr>
                    <th></th>
                    <td id="name"></td>
                  </tr>
                  <tr>
                    <th>Country:</th>
                    <td id="country">N/A</td>
                  </tr>
                </tbody>
              </table>
              <button
                class="btn btn-danger"
                value="deny"
                onclick="confirmApproval(value)"
              >
                Deny
              </button>
              <button
                class="btn btn-success"
                value="foreign"
                onclick="confirmApproval(value)"
              >
                Approve as foreign
              </button>
              <button
                class="btn btn-success"
                value="local"
                onclick="confirmApproval(value)"
              >
                Approve as local
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      class="modal fade"
      id="confirm"
      data-backdrop="static"
      tabindex="-1"
      role="dialog"
      aria-labelledby="staticBackdropLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">
              Please Confirm Your Action
            </h5>
          </div>
          <div id="confirm-text" class="modal-body"></div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
              autofocus
            >
              Cancel
            </button>
            <button
              id="confirm-btn"
              value=""
              onclick="handleApproval(value)"
              type="button"
              class="btn btn-primary"
            >
              Confirm
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
