<!DOCTYPE html>
<html lang="en">
  <head>
    <title>MUN deputy registration</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/jquery.validate.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.1/additional-methods.min.js"></script>
    <script src="https://unpkg.com/xregexp/xregexp-all.js"></script>
    <link href="./dist/css/bootstrap-select.min.css" rel="stylesheet" />
    <script src="./dist/js/bootstrap-select.min.js"></script>
    <script>
      function legalfix() {
        if (!$("#legal").valid()) {
          $(".form-check-label").after($("label#legal-error"));
          console.log();
        }
      }
      function countryfix() {
        console.log("cout-avail");
        if (!$("#country").valid()) {
          $(".dropdown-toggle.btn-light")
            .eq(0)
            .addClass("is-invalid");
          $(".dropdown-toggle.btn-light")
            .eq(0)
            .after($("label#country-error"));
          console.log();
        } else {
          $(".dropdown-toggle.btn-light")
            .eq(0)
            .removeClass("is-invalid");
        }
      }
      $(document).ready(function() {
        data = Array(2);
        data[0] = Object({ name: "action", value: "get" });
        data[1] = Object({ name: "available", value: "1" });
        console.log(data);
        $.ajax({
          type: "POST",
          url: "/api/countries",
          data: data,
          dataType: "json",
          success: function(data) {
            if (data.success) {
              data.countries.map(function(country) {
                console.log(country);
                $("#country").append(
                  `<option value=${country[0]}>${country[1]}</option>`
                );
              });
              $("#country").selectpicker({
                liveSearch: true,
                dropupAuto: false,
                size: 6
              });
            } else {
              alert(data.msg);
            }
          },
          error: function(data) {
            alert(data.msg);
          }
        });

        data = Array(2);
        data[0] = Object({ name: "action", value: "get" });
        data[1] = Object({ name: "reserved", value: "1" });
        console.log(data);
        $.ajax({
          type: "POST",
          url: "/api/countries",
          data: data,
          dataType: "json",
          success: function(data) {
            if (data.success) {
              $("#reservedcountry").append(`<option value="">None</option>`);
              data.countries.map(function(country) {
                console.log(country);
                $("#reservedcountry").append(
                  `<option value=${country[0]}>${country[1]}</option>`
                );
              });
              if (data.countries.length === 0) {
                $("#reservedcountry").append(
                  `<option value="">No reserved countries</option>`
                );
              }
              $("#reservedcountry").selectpicker({
                liveSearch: true,
                dropupAuto: false,
                size: 6
              });
            } else {
              alert(data.msg);
            }
          },
          error: function(data) {
            alert(data.msg);
          }
        });

        $.validator.addMethod(
          "regex",
          function(value, element, regexp) {
            var re = new XRegExp(regexp);
            return this.optional(element) || re.test(value);
          },
          "Please check your input"
        );
        $("#need-validation").validate({
          rules: {
            name: {
              regex: "^((['`\\-\\p{L}])+[ ]?)*$",
              minlength: 2,
              maxlength: 30
            },
            surname: {
              regex: "^((['`\\-\\p{L}])+[ ]?)*$",
              minlength: 2,
              maxlength: 30
            },
            institution: {
              regex: "^((['`.,№#\"\\-\\p{L}0-9])+[ ]?)*$",
              minlength: 5,
              maxlength: 40
            },
            gradeletter: {
              regex: "^[\\p{Lu}]$"
            },
            phone: {
              regex:
                "^(([\\+][0-9]{11})|(^[\\+][0-9][\\-][0-9]{3}[\\-][0-9]{3}[\\-][0-9]{4})|(^[\\+][0-9][(][0-9]{3}[)][0-9]{3}[\\-][0-9]{4})|(^[\\+][0-9][(][0-9]{4}[)][0-9]{3}[\\-][0-9]{3}))$"
            },
            email: {
              email: true
            },
            confirmemail: {
              equalTo: email
            },
            subject: {
              maxlength: 40,
              regex: "^((['`\\-\\p{L}])+[ ]?)*$"
            }
          },
          messages: {
            name: {
              regex: "Use only letters, space and -'` characters",
              required: "Required for certificates and account info"
            },
            surname: {
              regex: "Use only letters, space and -'` characters",
              required: "Required for certificates and account info"
            },
            institution: {
              regex: "Use only letters, space and -'`.,№# characters",
              required: "Required for statistical purposes"
            },
            gradeletter: {
              regex: "Use one uppercase letter"
            },
            phone: {
              regex:
                'Use <span style="color:blue"> +xxxxxxxxxxx  +x-xxx-xxx-xxxx <br> +x(xxx)xxx-xxxx +x(xxxx)xxx-xxx </span> format',
              required: "Required to contact you"
            },
            email: {
              email: "Must resemble name@domain.com format",
              required: "Required to send account information"
            },
            country: {
              required: "Required to assign you a country"
            },
            legal: {
              required: "This agreement is required"
            }
          },
          errorClass: "is-invalid"
        });

        if ($("#role").val() === "student") {
          $("#teacherfield").hide();
          $("#studentfield").show();
        } else {
          $("#studentfield").hide();
          $("#teacherfield").show();
        }
        $("#role").on("change", function() {
          if (this.value === "student") {
            $("#teacherfield").hide();
            $("#studentfield").show();
          } else {
            $("#studentfield").hide();
            $("#teacherfield").show();
          }
        });

        $("#confirmemail").on("paste", function(event) {
          event.preventDefault();
        });

        $("#need-validation").submit(function(event) {
          event.preventDefault();
          if ($(this).valid()) {
            var data = $(this).serializeArray();
            //data = encodeURIComponent(data);
            console.log(data);
            $.ajax({
              type: "POST",
              url: "/api/register",
              data: data,
              dataType: "json",
              success: function(data) {
                console.log(data);
              },
              error: function(data) {
                console.log(data.responseJSON);
                if (data.responseJSON.validity)
                  data.responseJSON.validity.map(function(elname) {
                    $("#" + elname).addClass("is-invalid");
                    alert(data.responseJSON.msg);
                  });
              }
            });
          }
        });
      });
    </script>
  </head>

  <body>
    <div class="container">
      <div class="card" style="width: 100%; margin-top: 50px;">
        <div class="card-body">
          <h5 class="card-title">Model UN Delegate Registration Form</h5>
          <h6 class="card-subtitle mb-2 text-muted">
            Registration is open for everyone. <br />
            Please consider planning your arrival to the event.
          </h6>
          <form action="../app/register/index.php" id="need-validation">
            <div class="form-row">
              <div class="form-group col-lg-3 col-md-6">
                <label for="email"
                  >Email <span class="attention">*</span><br />
                  <small>Used to cantact and send account info</small></label
                >
                <input
                  name="email"
                  type="email"
                  class="form-control"
                  id="email"
                  required
                />
              </div>
              <div class="form-group col-lg-3 col-md-6">
                <label for="confirmemail"
                  >Confirm email <span class="attention">*</span><br />
                  <small>Prevent any typo</small></label
                >
                <input
                  name="confirmemail"
                  type="text"
                  class="form-control"
                  id="confirmemail"
                  required
                />
              </div>
              <div class="form-group col-lg-3 col-md-6">
                <label for="name"
                  >First Name <span class="attention">*</span> <br />
                  <small>Used in certificates, fill in carefully</small></label
                >
                <input
                  name="name"
                  type="text"
                  class="form-control"
                  id="name"
                  required
                />
              </div>
              <div class="form-group col-lg-3 col-md-6">
                <label for="surname"
                  >Last Name <span class="attention">*</span><br />
                  <small>Used in certificates, fill in carefully</small></label
                >
                <input
                  name="surname"
                  type="text"
                  class="form-control"
                  id="surname"
                  required
                />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-lg-3 col-md-6">
                <label for="institution"
                  >Your School/College/Usniversity Name
                  <span class="attention">*</span></label
                >
                <input
                  name="institution"
                  type="text"
                  class="form-control"
                  id="institution"
                  placeholder="NIS PhM Uralsk"
                  required
                />
              </div>
              <div class="form-group col-md-2 col-lg-3">
                <label for="role">Role <span class="attention">*</span></label>
                <select name="role" class="custom-select" id="role" required>
                  <option value="student">Student</option>
                  <option value="teacher">Teacher</option>
                </select>
              </div>
              <div class="col-md-4 col-lg-3">
                <div class="form-row" id="studentfield">
                  <div class="form-group col-md-6">
                    <label for="grade">Grade</label>
                    <select name="grade" class="custom-select" id="grade">
                      <option value=""></option>
                      <option value="7">7</option>
                      <option value="8">8</option>
                      <option value="9">9</option>
                      <option value="10">10</option>
                      <option value="11">11</option>
                      <option value="12">12</option>
                    </select>
                  </div>
                  <div class="form-group col-md-6">
                    <label for="gradeletter">Grade Letter</label>
                    <input
                      name="gradeletter"
                      type="text"
                      class="form-control"
                      id="gradeletter"
                    />
                  </div>
                </div>
                <div class="form-row" id="teacherfield">
                  <div class="form-group teacherfield col-md-12">
                    <label for="subject">Subject You Teach</label>
                    <input
                      name="subject"
                      type="text"
                      class="form-control"
                      id="subject"
                    />
                  </div>
                </div>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="phone"
                  >Phone Number <span class="attention">*</span></label
                >
                <input
                  name="phone"
                  type="tel"
                  class="form-control"
                  id="phone"
                  required
                />
              </div>
              <div class="form-group col-md-4">
                <label for="topic">Topic Preference</label>
                <select name="topic" class="custom-select" id="topic">
                  <option value="">No Preference</option>
                  <option value="climate"
                    >Climate Change Affecting Forest Fires</option
                  >
                  <option value="child"
                    >Eliminating Child Abuse and Trafficking</option
                  >
                  <option value="disease">Disease Epidemic Control</option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="country"
                  >Select Your Country <span class="attention">*</span></label
                >
                <select
                  name="country"
                  type="text"
                  class="country form-control"
                  id="country"
                  onchange="countryfix()"
                  required
                >
                  <option value=""></option>
                </select>
              </div>
              <div class="form-group col-md-4">
                <label for="reservedcountry">Reserved countries</label>
                <p>
                  <i>
                    You will be assigned to the selected country if it becomes
                    available
                  </i>
                </p>
                <select
                  name="reservedcountry"
                  type="text"
                  class="country form-control"
                  id="reservedcountry"
                >
                </select>
              </div>
            </div>
            <div style="width: 100%;">
              <div class="form-check">
                <input
                  name="legal"
                  class="form-check-input"
                  type="checkbox"
                  value="agree"
                  id="legal"
                  required
                />
                <label class="form-check-label" for="legal">
                  <span class="attention">*</span>
                  I agree to
                  <a href="#">Privacy Policy</a>
                  and
                  <a href="#">Terms of Use</a>
                </label>
              </div>
              <button
                type="submit"
                style="float:right;"
                class="btn btn-md btn-primary"
                onclick="countryfix(); legalfix();"
              >
                Submit
              </button>
              <p></p>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
